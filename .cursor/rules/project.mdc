---
description: Project conventions and coding standards for web-whiteboard
globs: ["**/*.{js,jsx,ts,tsx,css}"]
alwaysApply: true
---

# Web Whiteboard - Project Rules

## Project Overview

A lightweight, infinite canvas whiteboard app built with React 19 and Vite. Features include:
- Infinite pan/zoom canvas with grid
- Multiple brush tools: pen, marker, highlighter, eraser
- Touch support with pinch-to-zoom
- Image paste/drop support
- Light/dark theme (follows system preference)
- Keyboard shortcuts (Cmd/Ctrl+Z undo, Cmd/Ctrl+Shift+Z redo)

## Tech Stack

- **Framework**: React 19.1+ with Vite 7
- **Language**: JavaScript (JSX) - no TypeScript in components
- **Styling**: CSS Modules for components, global CSS variables in `src/styles/`
- **Testing**: Vitest + React Testing Library
- **Linting**: ESLint

## File Structure (Feature-Based Architecture)

We use **Feature-Based (Screaming) Architecture** where top-level folders represent business domains, not technology types.

```
src/
├── styles/              # Global styles (variables, reset, typography, utilities)
├── components/          # SHARED, DUMB UI only (knows nothing about features)
│   ├── IconButton/
│   ├── ThemeToggle/
│   └── Tooltip/
├── hooks/               # APP-WIDE generic hooks only
│   └── useTheme.js      # Could be used in any project
├── utils/               # APP-WIDE generic helpers only
│   └── math.js          # Generic math functions
├── features/            # THE CORE BUSINESS LOGIC
│   └── Whiteboard/      # Everything for the drawing feature
│       ├── components/  # Components ONLY used by Whiteboard
│       │   ├── Canvas/
│       │   ├── BrushPalette/
│       │   ├── Toaster/
│       │   └── FooterBadge/
│       ├── hooks/       # Domain-specific hooks
│       │   ├── useCanvasSetup.js
│       │   ├── useCanvasView.js
│       │   ├── useStrokeManager.js
│       │   ├── useKeyboardShortcuts.js
│       │   ├── useWheelZoom.js
│       │   ├── usePinchZoom.js
│       │   └── useImagePaste.js
│       ├── utils/       # Canvas-specific utilities
│       │   └── canvas.js
│       ├── constants/   # Tool definitions, colors, sizes
│       │   ├── tools.js
│       │   └── colors.js
│       └── index.js     # Public API - only export what App needs
├── App.jsx
├── App.css
└── index.jsx
```

### Architecture Rules

**1. Feature Encapsulation**
- All whiteboard logic lives in `features/Whiteboard/`
- The feature has its own hooks/, components/, utils/, constants/
- `index.js` exports only the public API

**2. Shared Components (`src/components/`)**
- Only "dumb" UI components (Button, Modal, Tooltip)
- Know nothing about canvas or drawing logic
- Reusable across any feature

**3. Global Hooks (`src/hooks/`)**
- Only hooks that could work in any project
- If a hook mentions "Canvas", "Stroke", "Zoom" → it belongs in the feature

**4. Import Rules**
```js
// ✓ GOOD: Feature imports shared components
import { IconButton } from '@/components/IconButton';

// ✓ GOOD: Feature imports its own hooks (relative)
import { useStrokeManager } from './hooks/useStrokeManager';

// ✓ GOOD: App imports feature's public API
import { Whiteboard } from '@/features/Whiteboard';

// ✗ BAD: App imports feature internals
import { BrushPalette } from '@/features/Whiteboard/components/BrushPalette';
```

## CSS Conventions

### Global Variables (src/styles/variables.css)

Always use CSS custom properties for consistency:

```css
/* Spacing */
var(--spacing-xs)   /* 4px */
var(--spacing-sm)   /* 6px */
var(--spacing-md)   /* 8px */
var(--spacing-lg)   /* 10px */
var(--spacing-xl)   /* 12px */

/* Border Radius */
var(--radius-sm)    /* 8px */
var(--radius-md)    /* 10px */
var(--radius-pill)  /* 999px */

/* Z-Index Scale */
var(--z-canvas)     /* 1 */
var(--z-palette)    /* 16 */
var(--z-toaster)    /* 19 */
var(--z-toggle)     /* 20 */
var(--z-badge)      /* 21 */
var(--z-popover)    /* 100 */

/* Theme Colors */
var(--bg)           /* Background */
var(--text)         /* Text color */
var(--panel-bg)     /* Panel background */
var(--panel-border) /* Panel border */
var(--accent)       /* Accent color */
```

### CSS Module Naming

- Use camelCase for class names: `.paletteBtn`, `.toasterContent`
- Keep selectors flat, avoid deep nesting
- Mobile-first approach with `@media (hover: hover) and (pointer: fine)` for desktop

### Minimal Comments

- Avoid excessive comment headers in CSS
- Only add comments for non-obvious code
- No section dividers like `/* ========== */`

## React Conventions

### Component Structure

```jsx
import React from 'react'
import styles from './ComponentName.module.css'

export default function ComponentName({ prop1, prop2 }) {
  // hooks first
  const [state, setState] = React.useState(initial)
  
  // derived values
  const computed = React.useMemo(() => ..., [deps])
  
  // callbacks
  const handleClick = React.useCallback(() => ..., [deps])
  
  // effects last
  React.useEffect(() => ..., [deps])
  
  return (
    <div className={styles.container}>
      ...
    </div>
  )
}
```

### Hooks Usage

- Prefer `React.useState`, `React.useEffect` over destructured imports
- Use refs for mutable values that don't trigger re-renders
- Extract complex logic into custom hooks in `src/hooks/`

### Barrel Exports

Each component folder has an `index.js`:

```js
export { default } from './ComponentName.jsx'
```

## Canvas/Drawing Specific

### Coordinate Systems

- **Screen space**: Pixel coordinates from mouse/touch events
- **World space**: Infinite canvas coordinates (after pan/zoom transform)
- Use `screenToWorld(sx, sy)` to convert between them

### Stroke Data Structure

```js
{
  mode: 'theme' | 'custom' | 'image',
  points: [{ x, y, p }],  // p = pressure
  size: number,
  color: string | undefined,
  alpha: number,
  erase: boolean,
  cap: 'round',
  join: 'round'
}
```

### View State

```js
{
  panX: number,   // horizontal offset
  panY: number,   // vertical offset  
  scale: number   // zoom level (0.05 to 20)
}
```

## Testing

### Test Framework
- **Vitest** for test runner
- **React Testing Library** for component tests
- **jsdom** environment

### Test File Naming
- Place tests next to source files: `useCanvasView.js` → `useCanvasView.test.js`
- Component tests: `ComponentName.test.jsx`
- Utility tests: `utilName.test.js`

### Commands
```bash
npm test          # Watch mode
npm test -- --run # Run once (CI)
```

### Test Structure
```js
import { describe, it, expect, vi } from 'vitest';
import { renderHook, act } from '@testing-library/react';

describe('hookName', () => {
  it('describes expected behavior', () => {
    const { result } = renderHook(() => useMyHook());
    
    act(() => {
      result.current.doSomething();
    });
    
    expect(result.current.value).toBe(expected);
  });
});
```

### Testing Guidelines
- Test behavior, not implementation
- Use `renderHook` for custom hooks
- Use `render` + `screen` for components
- Mock canvas APIs in `vitest.setup.js`
- Avoid testing internal state directly

### Current Test Coverage
- `src/utils/canvas.test.js` - clamp, getThemeColors
- `src/hooks/useCanvasSetup.test.js` - DPR scaling, resize
- `src/hooks/useCanvasView.test.js` - pan/zoom, coordinate conversion
- `src/hooks/useStrokeManager.test.js` - undo/redo history
- `src/App.test.jsx` - help panel interaction

## Git Workflow

- Keep commits focused and atomic
- Run `npm run lint` before committing
- Run `npm run typecheck` to verify types
